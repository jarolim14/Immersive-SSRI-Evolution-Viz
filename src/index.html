<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pharmaceuticals and Publications</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="./style.css" />
    <style>
      /* Intro video overlay */
      .video-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        backdrop-filter: blur(2px);
      }
      .video-overlay.show {
        display: flex;
      }
      .video-container {
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }
      #demoVideo {
        width: auto; /* use intrinsic width for best quality */
        max-width: 90vw;
        height: auto;
        max-height: 80vh;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        background: #000;
        display: block;
      }

      /* Mobile video improvements */
      @media (max-width: 768px) {
        #demoVideo {
          width: 100%;
          max-width: 95vw;
          max-height: 70vh;
          border-radius: 8px;
        }

        .video-container {
          max-width: 95vw;
          max-height: 80vh;
          padding: 10px;
        }
      }
      .video-controls {
        display: flex;
        gap: 10px;
      }
      .video-btn {
        background: #111;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-family: inherit;
      }
      .video-btn.primary {
        background: #ff3d5a;
        border-color: #ff3d5a;
      }
      /* Reopen button bottom-right */
    </style>
  </head>
  <body>
    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
      <div class="modal-content">
        <!-- Loading Section -->
        <div id="loadingContent" class="modal-section">
          <h2>Loading Data</h2>
          <div class="loading-spinner"></div>
          <p id="loadingStatus">Loading visualization data...</p>
        </div>

        <!-- Instructions Section -->
        <div id="instructionsContent" class="modal-section">
          <h2>Network Visualization Guide</h2>
          <div class="instructions-container">
            <div class="instruction-item">
              <h3>What You're Looking At</h3>
              <ul>
                <li>üìÑ Each node represents a scientific paper</li>
                <li>
                  üîó A line between nodes represents a citation or high semantic
                  similarity
                </li>
                <li>
                  üé® Color represents the paper's overall category (see legend
                  and topic hierarchy)
                </li>
                <li>
                  üåà Shades within each color indicate clusters within that
                  category
                </li>
                <li>üìç Similar papers are positioned closer together</li>
              </ul>
            </div>
            <div class="instruction-item">
              <h3>Basic Controls</h3>
              <ul>
                <li>üñ±Ô∏è Left Mouse Button: Rotate the view</li>
                <li>üñ±Ô∏è Right Mouse Button: Pan the view</li>
                <li>üñ±Ô∏è Mouse Wheel: Zoom in/out</li>
              </ul>
            </div>
            <div class="instruction-item">
              <h3>Interactive Features</h3>
              <ul>
                <li>üñ±Ô∏è Click on a node to select it and view paper details</li>
                <li>
                  üìÖ Use the year slider to filter papers by publication date
                </li>
                <li>üè∑Ô∏è Toggle node visibility using the legend</li>
                <li>
                  ‚è≥ Use <strong>Time Evolution</strong> to watch how clusters
                  developed over time. Select clusters from the legend, adjust
                  the year sliders, and click Play
                </li>
                <li>
                  üîç Search for papers by title or DOI using the search box at
                  the bottom
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Error Section -->
        <div id="errorContent" class="modal-section">
          <h2>Error</h2>
          <p id="errorMessage"></p>
        </div>

        <div class="modal-footer">
          <div class="button-group">
            <button id="instructionsCloseBtn" class="close-btn">Got it!</button>
            <button id="viewTopicHierarchyBtn" class="view-hierarchy-btn">
              View Topic Hierarchy
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Recording Modal -->
    <div id="videoRecordingModal" class="modal">
      <div class="modal-content">
        <h2>Video Recording</h2>
        <div class="video-recording-container">
          <div id="videoCompatibilityStatus" class="compatibility-status">
            <h3>Browser Compatibility Check</h3>
            <div class="compatibility-items">
              <div class="compatibility-item">
                <span class="label">MediaRecorder API:</span>
                <span id="mediaRecorderSupport" class="status"
                  >Checking...</span
                >
              </div>
              <div class="compatibility-item">
                <span class="label">WebM/VP9 Codec:</span>
                <span id="webmVp9Support" class="status">Checking...</span>
              </div>
              <div class="compatibility-item">
                <span class="label">WebM/VP8 Codec:</span>
                <span id="webmVp8Support" class="status">Checking...</span>
              </div>
              <div class="compatibility-item">
                <span class="label">MP4 Codec:</span>
                <span id="mp4Support" class="status">Checking...</span>
              </div>
            </div>
          </div>

          <div class="video-info">
            <h3>About Video Recording</h3>
            <p>
              This feature allows you to create a demonstration video of the
              visualization with programmed interactions. The video will show:
            </p>
            <ul>
              <li>Overview of the network</li>
              <li>Year-based filtering</li>
              <li>Cluster selection</li>
              <li>Paper search</li>
              <li>Time evolution</li>
            </ul>
            <p>
              <strong>Note:</strong> If your browser doesn't fully support video
              recording, a fallback method will be used to capture individual
              frames as images. These can be converted to video using external
              tools like FFmpeg.
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button id="videoRecordingCloseBtn" class="close-btn">Close</button>
        </div>
      </div>
    </div>

    <!-- Help Button -->
    <button id="helpButton" class="help-button">?</button>
    <!-- Credits Button -->
    <button id="creditsButton" class="help-button credits-button">¬©</button>

    <!-- Canvas for WebGL rendering -->
    <canvas class="webgl"></canvas>
    <!-- Add the node id div element -->
    <div id="nodeInfoDiv">Selected Node:</div>
    <!-- Add legend to top right corner -->
    <div id="legendDiv">
      <button id="updateVisibility" class="update-button">
        Update Selection
      </button>
      <button id="resetLegend" class="reset-button">Reset All</button>
    </div>
    <!-- Year slider -->
    <div id="year-slider-container">
      <div class="range_container">
        <div class="sliders_control">
          <input
            id="fromSlider"
            type="range"
            value="1982"
            min="1982"
            max="2025"
          />
          <input
            id="toSlider"
            type="range"
            value="2025"
            min="1982"
            max="2025"
          />
        </div>
        <div class="form_control">
          <span id="fromValue">1982</span>
          <span id="toValue">2025</span>
        </div>
      </div>
    </div>

    <!-- Color legend -->
    <div id="colorLegendDiv">
      <div class="legend-item">
        <div class="color-box pharmacology"></div>
        <span>Pharmacology</span>
      </div>
      <div class="legend-item">
        <div class="color-box indications"></div>
        <span>Indications</span>
      </div>
      <div class="legend-item">
        <div class="color-box safety"></div>
        <span>Safety</span>
      </div>
      <div class="legend-item">
        <div class="color-box other"></div>
        <span>Other</span>
      </div>
    </div>

    <!-- Credits Modal -->
    <div id="creditsModal" class="modal">
      <div class="modal-content">
        <h2>Credits</h2>
        <div class="credits-container">
          <div class="credits-section">
            <h3>Data Analysis</h3>
            <ul>
              <li>Lukas Westphal</li>
            </ul>
          </div>
          <div class="credits-section">
            <h3>Visualization</h3>
            <ul>
              <li>Lukas Westphal</li>
            </ul>
          </div>
          <div class="credits-section">
            <h3>Conceptualization</h3>
            <ul>
              <li>Lukas Westphal</li>
              <li>D√©bora Gr√§f</li>
              <li>Christine Hallgreen</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button id="creditsCloseBtn" class="close-btn">Close</button>
        </div>
      </div>
    </div>

    <!-- Topic Tree Modal -->
    <div id="topicTreeModal" class="modal">
      <div class="modal-content">
        <h2>Topic Hierarchy</h2>
        <div class="topic-tree-container">
          <select id="datasetSelect" class="topic-select">
            <option value="overview" selected>Overview</option>
            <option value="pharmacology">Pharmacology</option>
            <option value="indications">Indications</option>
            <option value="safety">Safety</option>
            <option value="other">Other</option>
          </select>
          <div class="topic-tree-controls">
            <button id="saveTreeButton" class="save-button">Save as SVG</button>
          </div>
          <div id="topicTreeSvg"></div>
        </div>
        <div class="modal-footer">
          <button id="topicTreeCloseBtn" class="close-btn">Close</button>
        </div>
      </div>
    </div>

    <script type="module" src="main.js"></script>

    <!-- Centered intro video overlay -->
    <div id="introVideoOverlay" class="video-overlay show">
      <div class="video-container">
        <video
          id="demoVideo"
          src="video/network-visualization-demo20250630.webm"
          playsinline
          preload="auto"
          controls
        ></video>
        <div class="video-controls">
          <button id="skipVideoBtn" class="video-btn">Skip</button>
        </div>
      </div>
    </div>

    <!-- Reopen video button -->
    <button
      id="reopenVideoBtn"
      class="help-button video-button"
      title="Replay intro video"
    >
      ‚ñ∂
    </button>

    <script type="module">
      // Intro video controller module
      class IntroVideoController {
        constructor() {
          this.overlay = document.getElementById("introVideoOverlay");
          this.video = document.getElementById("demoVideo");
          this.skipBtn = document.getElementById("skipVideoBtn");
          this.reopenBtn = document.getElementById("reopenVideoBtn");
          this.isPlaying = false;
          this.container = this.overlay
            ? this.overlay.querySelector(".video-container")
            : null;
          this.isMobile = this.detectMobile();

          this.init();
        }

        init() {
          this.bindEvents();
          // On mobile, do not autoplay; require explicit play with sound
          if (!this.isMobile) {
            this.tryAutoplayMuted();
          } else {
            this.video.muted = false;
            this.video.controls = true;
            // Ensure video is visible on mobile
            this.video.style.display = "block";
            this.video.style.width = "100%";
            this.video.style.height = "auto";

            // Add loading event listeners
            this.video.addEventListener("loadstart", () => {
              console.log("Video loading started");
            });

            this.video.addEventListener("canplay", () => {
              console.log("Video can start playing");
            });

            // Add a fallback if video doesn't load
            this.video.addEventListener("error", () => {
              console.log("Video failed to load, showing skip option");
              this.showSkipOption();
            });

            // Add timeout fallback for mobile
            setTimeout(() => {
              if (this.video.readyState < 2) {
                // HAVE_CURRENT_DATA
                console.log(
                  "Video taking too long to load, showing skip option"
                );
                this.showSkipOption();
              }
            }, 5000);
          }
        }

        bindEvents() {
          this.skipBtn.addEventListener("click", () => this.hideOverlay());
          this.reopenBtn.addEventListener("click", () =>
            this.showOverlayAndReplay()
          );

          this.video.addEventListener("click", () => this.handleVideoClick());
          this.video.addEventListener("ended", () => this.hideOverlay());
          this.video.addEventListener("play", () => {
            this.isPlaying = true;
          });
          this.video.addEventListener("pause", () => {
            this.isPlaying = false;
          });

          // Close overlay when clicking outside the video container
          if (this.overlay) {
            this.overlay.addEventListener("click", (e) => {
              if (!this.container) return;
              if (!this.container.contains(e.target)) {
                this.hideOverlay();
              }
            });
          }
        }

        tryAutoplayMuted() {
          try {
            this.video.muted = true;
            const playPromise = this.video.play();
            if (playPromise && typeof playPromise.then === "function") {
              playPromise.catch(() => {
                // Ignore; user can press controls to start
              });
            }
          } catch (_) {}
        }

        handleVideoClick() {
          if (this.isMobile) return; // rely on native controls on mobile
          if (this.video.muted) {
            this.video.muted = false;
            this.video.volume = 1.0;
            this.video.play().catch(() => {});
          }
        }

        hideOverlay() {
          this.overlay.classList.remove("show");
          // Pause video when overlay is hidden
          if (this.isPlaying) {
            this.video.pause();
            this.isPlaying = false;
          }
        }

        showOverlayAndReplay() {
          this.overlay.classList.add("show");
          this.video.currentTime = 0;
          if (!this.isMobile) {
            this.tryAutoplayMuted();
          } else {
            this.video.muted = false;
          }
        }

        showSkipOption() {
          // Make skip button more prominent on mobile if video fails
          if (this.skipBtn) {
            this.skipBtn.style.background = "#ff3d5a";
            this.skipBtn.style.fontSize = "18px";
            this.skipBtn.style.padding = "12px 20px";
            this.skipBtn.textContent = "Continue to App";
          }
        }

        detectMobile() {
          const ua = navigator.userAgent || navigator.vendor || window.opera;
          const isTouch =
            window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
          return /android|iphone|ipad|ipod/i.test(ua) || isTouch;
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener(
          "DOMContentLoaded",
          () => new IntroVideoController()
        );
      } else {
        new IntroVideoController();
      }
    </script>
  </body>
</html>
